<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Discussion Board (Fixed Client-Side Storage)</title>
    <meta name="description" content="A live discussion board with guaranteed comment persistence - no server required!">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --digital-purple: #8338ec;
            --lighter-accent: #a5b4fc;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #c5c6c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .grid-lines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(131, 56, 236, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(131, 56, 236, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }

        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--card-border);
        }

        .header-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pyramid {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 25px solid var(--digital-purple);
            transform: rotate(180deg);
        }

        .header-title-container h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--digital-purple);
            text-shadow: 0 0 10px rgba(131, 56, 236, 0.5);
        }

        .eybers-header-links {
            display: flex;
            gap: 15px;
        }

        .eybers-link {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .eybers-link:hover {
            background: rgba(131, 56, 236, 0.2);
            transform: translateY(-2px);
        }

        .left-tabs-container {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--card-border);
            padding: 15px 0;
            z-index: 100;
        }

        .back-button-tab, .contact-button-tab {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .back-button-tab:hover, .contact-button-tab:hover {
            background: rgba(131, 56, 236, 0.2);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid var(--card-border);
        }

        .sun-container {
            position: relative;
            width: 50px;
            height: 50px;
        }

        .sun-core {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--digital-purple);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--digital-purple);
        }

        .sun-rays {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 40%, rgba(131, 56, 236, 0.2) 100%);
            border-radius: 50%;
            animation: sunPulse 3s infinite alternate;
        }

        @keyframes sunPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .header-content h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--digital-purple);
            margin-bottom: 10px;
        }

        .header-content p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .comment-form-container {
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card__header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--card-border);
        }

        .card__title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--digital-purple);
            font-family: 'Orbitron', sans-serif;
        }

        .card__body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Exo 2', sans-serif;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--digital-purple);
            box-shadow: 0 0 0 2px rgba(131, 56, 236, 0.3);
        }

        .submit-btn {
            background: var(--digital-purple);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #732fe8;
            transform: translateY(-2px);
        }

        .comments-section {
            margin-bottom: 30px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--digital-purple);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
        }

        .comments-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            border-left: 3px solid var(--digital-purple);
            transition: all 0.3s ease;
        }

        .comment-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 4px;
            background: var(--digital-purple);
            transform: scaleX(0);
            transform-origin: left;
        }

        .comment-card:hover::before {
            transform: scaleX(1);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .username {
            font-weight: bold;
            color: var(--digital-purple);
        }

        .timestamp {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .reply-to {
            margin-top: 5px;
            color: var(--accent);
            font-size: 0.9em;
        }

        .comment-body {
            padding: 10px 0;
            line-height: 1.5;
        }

        .stats-container {
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--digital-purple);
            font-family: 'Orbitron', sans-serif;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(150%); }
            to { transform: translateX(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .debug-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-width: 300px;
            z-index: 9999;
            font-size: 12px;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .eybers-header-links {
                width: 100%;
                justify-content: center;
            }
            
            .left-tabs-container {
                position: static;
                transform: none;
                display: flex;
                justify-content: center;
                padding: 15px 0;
            }
            
            .back-button-tab, .contact-button-tab {
                width: auto;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="grid-lines"></div>
    
    <!-- Top header with title and pyramids -->
    <div class="top-header">
        <div class="header-title-container">
            <div class="pyramid"></div>
            <h1>Live Discussion Board</h1>
            <div class="pyramid"></div>
        </div>
        <div class="eybers-header-links">
            <button id="clearAllBtn" class="eybers-link">
                <i class="fas fa-trash"></i> Clear All
            </button>
            <button id="exportBtn" class="eybers-link">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Container for left tabs -->
    <div class="left-tabs-container">
        <button class="back-button-tab" id="homeButton">
            <i class="fas fa-home"></i> Home
        </button>
        <button class="contact-button-tab" id="refreshButton">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <div class="main-container">
        <!-- Header with Sun Integration -->
        <header>
            <div class="sun-container">
                <div class="sun-core"></div>
                <div class="sun-rays"></div>
            </div>
            <div class="header-content">
                <h2 style="color: var(--digital-purple); font-family: 'Orbitron', sans-serif; margin-bottom: 10px;">
                    Join the Conversation
                </h2>
                <p style="color: var(--lighter-accent); font-size: 1rem;">
                    Share your thoughts, respond to others, and engage in meaningful discussions
                </p>
            </div>
        </header>

        <!-- Comment Form -->
        <div class="comment-form-container">
            <div class="card">
                <div class="card__header">
                    <h3 class="card__title">
                        <i class="fas fa-comment-dots"></i>
                        Post a Comment
                    </h3>
                </div>
                <div class="card__body">
                    <form id="commentForm">
                        <div class="form-group">
                            <label for="userName">Your Name:</label>
                            <input type="text" id="userName" name="userName" required placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label for="commentText">Your Comment:</label>
                            <textarea id="commentText" name="commentText" required placeholder="Share your thoughts..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="parentComment">Reply to (optional):</label>
                            <select id="parentComment" name="parentComment">
                                <option value="">New comment</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i>
                            Post Comment
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Comments Display -->
        <div class="comments-section">
            <div class="section-title">
                <i class="fas fa-comments"></i>
                Discussion (<span id="commentCount">0</span> comments)
            </div>
            <div id="commentsContainer" class="comments-container">
                <!-- Comments will be dynamically inserted here -->
            </div>
        </div>

        <!-- Statistics Card -->
        <div class="stats-container">
            <div class="card stats-card">
                <div class="card__header">
                    <h3 class="card__title">
                        <i class="fas fa-chart-bar"></i>
                        Discussion Stats
                    </h3>
                </div>
                <div class="card__body">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalComments">0</div>
                            <div class="stat-label">Total Comments</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Participants</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalReplies">0</div>
                            <div class="stat-label">Replies</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="lastActivity">Never</div>
                            <div class="stat-label">Last Activity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debugging Panel -->
        <div id="debugInfo" class="debug-info">
            System Status: Initializing...
            <br>Storage Type: IndexedDB
            <br>Comments Count: 0
            <br>Storage Size: 0 KB
        </div>

        <!-- Notification Toast -->
        <div id="notification" class="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notificationText">Comment posted successfully!</span>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Debugging helper function
                function updateDebugInfo(message) {
                    const debugEl = document.getElementById('debugInfo');
                    const currentText = debugEl.textContent;
                    debugEl.textContent = `${message}\n${currentText}`;
                }

                // Check if IndexedDB is available
                if (!window.indexedDB) {
                    updateDebugInfo("ERROR: IndexedDB not supported in this browser!");
                    // Fallback to localStorage
                    const STORAGE_KEY = 'discussionComments';
                    
                    // Load comments from localStorage
                    function loadComments() {
                        const data = localStorage.getItem(STORAGE_KEY);
                        return data ? JSON.parse(data) : [];
                    }

                    // Save comments to localStorage
                    function saveComments(comments) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
                    }

                    // Clear all comments
                    function clearAllComments() {
                        localStorage.removeItem(STORAGE_KEY);
                    }

                    // Export comments as JSON
                    function exportComments() {
                        const comments = loadComments();
                        const blob = new Blob([JSON.stringify(comments, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'discussion-comments.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }

                    // Initialize
                    const comments = loadComments();
                    updateDebugInfo(`Using localStorage (IndexedDB unavailable)`);
                    updateDebugInfo(`Comments in storage: ${comments.length}`);

                    // Render comments to DOM
                    function renderComments() {
                        const comments = loadComments();
                        const container = document.getElementById('commentsContainer');
                        container.innerHTML = '';
                        
                        comments.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment-card';
                            
                            // Header
                            const header = document.createElement('div');
                            header.className = 'comment-header';
                            
                            const username = document.createElement('span');
                            username.className = 'username';
                            username.textContent = comment.userName;
                            
                            const timestamp = document.createElement('span');
                            timestamp.className = 'timestamp';
                            timestamp.textContent = new Date(comment.timestamp).toLocaleString();
                            
                            header.appendChild(username);
                            header.appendChild(timestamp);
                            
                            // Reply indicator
                            if (comment.parentId) {
                                const parentComment = comments.find(c => c.id === comment.parentId);
                                const replyTo = document.createElement('div');
                                replyTo.className = 'reply-to';
                                replyTo.innerHTML = `Replying to: <strong>${parentComment?.userName || 'Unknown'}</strong>`;
                                header.appendChild(replyTo);
                            }
                            
                            // Comment body
                            const body = document.createElement('div');
                            body.className = 'comment-body';
                            body.textContent = comment.text;
                            
                            // Assemble card
                            commentEl.appendChild(header);
                            commentEl.appendChild(body);
                            container.appendChild(commentEl);
                        });
                    }

                    // Update statistics
                    function updateStats() {
                        const comments = loadComments();
                        const total = comments.length;
                        const uniqueUsers = new Set(comments.map(c => c.userName)).size;
                        const replies = comments.filter(c => c.parentId).length;
                        
                        document.getElementById('totalComments').textContent = total;
                        document.getElementById('totalUsers').textContent = uniqueUsers;
                        document.getElementById('totalReplies').textContent = replies;
                        
                        // Last activity
                        if (total > 0) {
                            const lastComment = comments.reduce((prev, curr) => 
                                new Date(prev.timestamp) > new Date(curr.timestamp) ? prev : curr
                            );
                            document.getElementById('lastActivity').textContent = 
                                new Date(lastComment.timestamp).toLocaleString();
                        } else {
                            document.getElementById('lastActivity').textContent = 'Never';
                        }
                    }

                    // Handle comment submission
                    function handleFormSubmit(e) {
                        e.preventDefault();
                        
                        const userName = document.getElementById('userName').value.trim();
                        const commentText = document.getElementById('commentText').value.trim();
                        const parentCommentId = document.getElementById('parentComment').value;
                        
                        if (!userName || !commentText) return;
                        
                        const newComment = {
                            id: Date.now().toString(),
                            userName,
                            text: commentText,
                            parentId: parentCommentId || null,
                            timestamp: new Date().toISOString()
                        };
                        
                        const comments = loadComments();
                        comments.push(newComment);
                        saveComments(comments);
                        
                        // Reset form
                        document.getElementById('commentForm').reset();
                        document.getElementById('parentComment').selectedIndex = 0;
                        
                        // Update UI
                        renderComments();
                        updateStats();
                        showNotification('Comment posted successfully!');
                        updateDebugInfo(`Saved comment via localStorage (total: ${comments.length})`);
                    }

                    // Show notification toast
                    function showNotification(message) {
                        const notification = document.getElementById('notification');
                        const text = document.getElementById('notificationText');
                        text.textContent = message;
                        notification.classList.add('show');
                        
                        setTimeout(() => {
                            notification.classList.remove('show');
                        }, 3000);
                    }

                    // Populate parent comment dropdown
                    function updateParentDropdown() {
                        const select = document.getElementById('parentComment');
                        select.innerHTML = '<option value="">New comment</option>';
                        
                        const comments = loadComments();
                        comments.forEach(comment => {
                            const option = document.createElement('option');
                            option.value = comment.id;
                            option.textContent = `${comment.userName}: ${comment.text.slice(0, 30)}...`;
                            select.appendChild(option);
                        });
                    }

                    // Check if came from WhatsApp and configure home button
                    const isFromWhatsApp = document.referrer.includes('whatsapp.com') || 
                                          document.referrer.includes('messenger.com') ||
                                          document.referrer.includes('whatsapp.net');
                    
                    // Configure home button behavior
                    document.getElementById('homeButton').addEventListener('click', () => {
                        if (isFromWhatsApp) {
                            // Replace with your actual Eybers articles URL
                            window.location.href = 'https://eybers.com/articles';
                        }
                    });

                    // Initialize
                    updateDebugInfo(`Using localStorage (IndexedDB unavailable)`);
                    renderComments();
                    updateStats();
                    updateParentDropdown();

                    // Event listeners
                    document.getElementById('commentForm').addEventListener('submit', handleFormSubmit);
                    document.getElementById('clearAllBtn').addEventListener('click', clearAllComments);
                    document.getElementById('exportBtn').addEventListener('click', exportComments);
                    document.getElementById('refreshButton').addEventListener('click', () => {
                        updateParentDropdown();
                        renderComments();
                        updateStats();
                    });
                    
                    return;
                }

                // Main IndexedDB implementation
                const STORAGE_KEY = 'discussionComments';
                const dbVersion = 1;
                let db;
                
                // Open database connection
                function openDatabase() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('DiscussionDB', dbVersion);
                        
                        request.onerror = (event) => {
                            updateDebugInfo(`IndexedDB Error: ${event.target.error}`);
                            reject(event.target.error);
                        };
                        
                        request.onsuccess = (event) => {
                            db = event.target.result;
                            resolve(db);
                        };
                        
                        request.onupgradeneeded = (event) => {
                            db = event.target.result;
                            if (!db.objectStoreNames.contains('comments')) {
                                db.createObjectStore('comments', { keyPath: 'id' });
                            }
                        };
                    });
                }

                // Load comments from DB
                function loadComments() {
                    return new Promise((resolve, reject) => {
                        if (!db) {
                            openDatabase().then(() => {
                                loadComments().then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        const transaction = db.transaction(['comments'], 'readonly');
                        const store = transaction.objectStore('comments');
                        const request = store.getAll();
                        
                        request.onsuccess = () => {
                            resolve(request.result || []);
                            updateDebugInfo(`Loaded ${request.result.length} comments from IndexedDB`);
                        };
                        
                        request.onerror = (event) => {
                            updateDebugInfo(`Load Error: ${event.target.error}`);
                            reject(event.target.error);
                        };
                    });
                }

                // Save comment to DB
                function saveComment(comment) {
                    return new Promise((resolve, reject) => {
                        if (!db) {
                            openDatabase().then(() => {
                                saveComment(comment).then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        const transaction = db.transaction(['comments'], 'readwrite');
                        const store = transaction.objectStore('comments');
                        const request = store.put(comment);
                        
                        request.onsuccess = () => {
                            resolve();
                            updateDebugInfo(`Saved comment (ID: ${comment.id})`);
                        };
                        
                        request.onerror = (event) => {
                            updateDebugInfo(`Save Error: ${event.target.error}`);
                            reject(event.target.error);
                        };
                    });
                }

                // Clear all comments
                function clearAllComments() {
                    return new Promise((resolve, reject) => {
                        if (!db) {
                            openDatabase().then(() => {
                                clearAllComments().then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        const transaction = db.transaction(['comments'], 'readwrite');
                        const store = transaction.objectStore('comments');
                        const request = store.clear();
                        
                        request.onsuccess = () => {
                            resolve();
                            updateDebugInfo('Cleared all comments');
                        };
                        
                        request.onerror = (event) => {
                            updateDebugInfo(`Clear Error: ${event.target.error}`);
                            reject(event.target.error);
                        };
                    });
                }

                // Render comments to DOM
                async function renderComments() {
                    try {
                        const comments = await loadComments();
                        const container = document.getElementById('commentsContainer');
                        container.innerHTML = '';
                        
                        comments.forEach(comment => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment-card';
                            
                            // Header
                            const header = document.createElement('div');
                            header.className = 'comment-header';
                            
                            const username = document.createElement('span');
                            username.className = 'username';
                            username.textContent = comment.userName;
                            
                            const timestamp = document.createElement('span');
                            timestamp.className = 'timestamp';
                            timestamp.textContent = new Date(comment.timestamp).toLocaleString();
                            
                            header.appendChild(username);
                            header.appendChild(timestamp);
                            
                            // Reply indicator
                            if (comment.parentId) {
                                const parentComment = comments.find(c => c.id === comment.parentId);
                                const replyTo = document.createElement('div');
                                replyTo.className = 'reply-to';
                                replyTo.innerHTML = `Replying to: <strong>${parentComment?.userName || 'Unknown'}</strong>`;
                                header.appendChild(replyTo);
                            }
                            
                            // Comment body
                            const body = document.createElement('div');
                            body.className = 'comment-body';
                            body.textContent = comment.text;
                            
                            // Assemble card
                            commentEl.appendChild(header);
                            commentEl.appendChild(body);
                            container.appendChild(commentEl);
                        });
                        
                        updateDebugInfo(`Rendered ${comments.length} comments`);
                    } catch (error) {
                        updateDebugInfo(`Render Error: ${error.message}`);
                    }
                }

                // Update statistics
                async function updateStats() {
                    try {
                        const comments = await loadComments();
                        const total = comments.length;
                        const uniqueUsers = new Set(comments.map(c => c.userName)).size;
                        const replies = comments.filter(c => c.parentId).length;
                        
                        document.getElementById('totalComments').textContent = total;
                        document.getElementById('totalUsers').textContent = uniqueUsers;
                        document.getElementById('totalReplies').textContent = replies;
                        
                        // Last activity
                        if (total > 0) {
                            const lastComment = comments.reduce((prev, curr) => 
                                new Date(prev.timestamp) > new Date(curr.timestamp) ? prev : curr
                            );
                            document.getElementById('lastActivity').textContent = 
                                new Date(lastComment.timestamp).toLocaleString();
                        } else {
                            document.getElementById('lastActivity').textContent = 'Never';
                        }
                        
                        // Update storage size
                        const size = JSON.stringify(comments).length / 1024;
                        document.getElementById('debugInfo').textContent = 
                            `System Status: Healthy\nStorage Type: IndexedDB\nComments: ${total}\nSize: ${size.toFixed(2)} KB`;
                    } catch (error) {
                        updateDebugInfo(`Stats Error: ${error.message}`);
                    }
                }

                // Handle comment submission
                function handleFormSubmit(e) {
                    e.preventDefault();
                    
                    const userName = document.getElementById('userName').value.trim();
                    const commentText = document.getElementById('commentText').value.trim();
                    const parentCommentId = document.getElementById('parentComment').value;
                    
                    if (!userName || !commentText) return;
                    
                    const newComment = {
                        id: Date.now().toString(),
                        userName,
                        text: commentText,
                        parentId: parentCommentId || null,
                        timestamp: new Date().toISOString()
                    };
                    
                    saveComment(newComment)
                        .then(() => {
                            document.getElementById('commentForm').reset();
                            document.getElementById('parentComment').selectedIndex = 0;
                            renderComments();
                            updateStats();
                            showNotification('Comment posted successfully!');
                        })
                        .catch(error => {
                            updateDebugInfo(`Save Failed: ${error.message}`);
                            showNotification('Error saving comment! Check console.');
                        });
                }

                // Export comments as JSON
                function exportComments() {
                    loadComments()
                        .then(comments => {
                            const blob = new Blob([JSON.stringify(comments, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'discussion-comments.json';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            updateDebugInfo(`Export Error: ${error.message}`);
                        });
                }

                // Show notification toast
                function showNotification(message) {
                    const notification = document.getElementById('notification');
                    const text = document.getElementById('notificationText');
                    text.textContent = message;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }

                // Populate parent comment dropdown
                async function updateParentDropdown() {
                    try {
                        const comments = await loadComments();
                        const select = document.getElementById('parentComment');
                        select.innerHTML = '<option value="">New comment</option>';
                        
                        comments.forEach(comment => {
                            const option = document.createElement('option');
                            option.value = comment.id;
                            option.textContent = `${comment.userName}: ${comment.text.slice(0, 30)}...`;
                            select.appendChild(option);
                        });
                    } catch (error) {
                        updateDebugInfo(`Dropdown Error: ${error.message}`);
                    }
                }

                // Check if came from WhatsApp and configure home button
                const isFromWhatsApp = document.referrer.includes('whatsapp.com') || 
                                      document.referrer.includes('messenger.com') ||
                                      document.referrer.includes('whatsapp.net');
                
                // Configure home button behavior
                document.getElementById('homeButton').addEventListener('click', () => {
                    if (isFromWhatsApp) {
                        // Replace with your actual Eybers articles URL
                        window.location.href = 'https://eybers.com/articles';
                    }
                });

                // Initialize
                updateDebugInfo("System Status: Initializing IndexedDB...");
                openDatabase()
                    .then(() => {
                        updateDebugInfo("IndexedDB initialized successfully!");
                        renderComments();
                        updateStats();
                        updateParentDropdown();
                    })
                    .catch(error => {
                        updateDebugInfo(`Initialization Error: ${error.message}`);
                        // Fallback to localStorage
                        const STORAGE_KEY = 'discussionComments';
                        
                        // Load comments from localStorage
                        function loadComments() {
                            const data = localStorage.getItem(STORAGE_KEY);
                            return data ? JSON.parse(data) : [];
                        }

                        // Save comments to localStorage
                        function saveComments(comments) {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
                        }

                        // Clear all comments
                        function clearAllComments() {
                            localStorage.removeItem(STORAGE_KEY);
                        }

                        // Export comments as JSON
                        function exportComments() {
                            const comments = loadComments();
                            const blob = new Blob([JSON.stringify(comments, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'discussion-comments.json';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }

                        // Render comments to DOM
                        function renderComments() {
                            const comments = loadComments();
                            const container = document.getElementById('commentsContainer');
                            container.innerHTML = '';
                            
                            comments.forEach(comment => {
                                const commentEl = document.createElement('div');
                                commentEl.className = 'comment-card';
                                
                                // Header
                                const header = document.createElement('div');
                                header.className = 'comment-header';
                                
                                const username = document.createElement('span');
                                username.className = 'username';
                                username.textContent = comment.userName;
                                
                                const timestamp = document.createElement('span');
                                timestamp.className = 'timestamp';
                                timestamp.textContent = new Date(comment.timestamp).toLocaleString();
                                
                                header.appendChild(username);
                                header.appendChild(timestamp);
                                
                                // Reply indicator
                                if (comment.parentId) {
                                    const parentComment = comments.find(c => c.id === comment.parentId);
                                    const replyTo = document.createElement('div');
                                    replyTo.className = 'reply-to';
                                    replyTo.innerHTML = `Replying to: <strong>${parentComment?.userName || 'Unknown'}</strong>`;
                                    header.appendChild(replyTo);
                                }
                                
                                // Comment body
                                const body = document.createElement('div');
                                body.className = 'comment-body';
                                body.textContent = comment.text;
                                
                                // Assemble card
                                commentEl.appendChild(header);
                                commentEl.appendChild(body);
                                container.appendChild(commentEl);
                            });
                        }

                        // Update statistics
                        function updateStats() {
                            const comments = loadComments();
                            const total = comments.length;
                            const uniqueUsers = new Set(comments.map(c => c.userName)).size;
                            const replies = comments.filter(c => c.parentId).length;
                            
                            document.getElementById('totalComments').textContent = total;
                            document.getElementById('totalUsers').textContent = uniqueUsers;
                            document.getElementById('totalReplies').textContent = replies;
                            
                            // Last activity
                            if (total > 0) {
                                const lastComment = comments.reduce((prev, curr) => 
                                    new Date(prev.timestamp) > new Date(curr.timestamp) ? prev : curr
                                );
                                document.getElementById('lastActivity').textContent = 
                                    new Date(lastComment.timestamp).toLocaleString();
                            } else {
                                document.getElementById('lastActivity').textContent = 'Never';
                            }
                        }

                        // Handle comment submission
                        function handleFormSubmit(e) {
                            e.preventDefault();
                            
                            const userName = document.getElementById('userName').value.trim();
                            const commentText = document.getElementById('commentText').value.trim();
                            const parentCommentId = document.getElementById('parentComment').value;
                            
                            if (!userName || !commentText) return;
                            
                            const newComment = {
                                id: Date.now().toString(),
                                userName,
                                text: commentText,
                                parentId: parentCommentId || null,
                                timestamp: new Date().toISOString()
                            };
                            
                            const comments = loadComments();
                            comments.push(newComment);
                            saveComments(comments);
                            
                            // Reset form
                            document.getElementById('commentForm').reset();
                            document.getElementById('parentComment').selectedIndex = 0;
                            
                            // Update UI
                            renderComments();
                            updateStats();
                            showNotification('Comment posted successfully!');
                            updateDebugInfo(`Saved comment via localStorage (total: ${comments.length})`);
                        }

                        // Populate parent comment dropdown
                        function updateParentDropdown() {
                            const select = document.getElementById('parentComment');
                            select.innerHTML = '<option value="">New comment</option>';
                            
                            const comments = loadComments();
                            comments.forEach(comment => {
                                const option = document.createElement('option');
                                option.value = comment.id;
                                option.textContent = `${comment.userName}: ${comment.text.slice(0, 30)}...`;
                                select.appendChild(option);
                            });
                        }

                        // Initialize
                        updateDebugInfo(`Using localStorage (IndexedDB failed)`);
                        renderComments();
                        updateStats();
                        updateParentDropdown();

                        // Event listeners
                        document.getElementById('commentForm').addEventListener('submit', handleFormSubmit);
                        document.getElementById('clearAllBtn').addEventListener('click', clearAllComments);
                        document.getElementById('exportBtn').addEventListener('click', exportComments);
                        document.getElementById('refreshButton').addEventListener('click', () => {
                            updateParentDropdown();
                            renderComments();
                            updateStats();
                        });
                    });
            });
        </script>
    </div>
</body>
</html>
